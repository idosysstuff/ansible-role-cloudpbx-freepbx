---
- name: Define base Asterisk version variables
  ansible.builtin.set_fact:
    asterisk_version: "{{ ast_ver }}"

    asterisk_version_full: "{{ ast_ver }}.1.0"

- name: Define derived Asterisk paths and URLs
  ansible.builtin.set_fact:
    asterisk_download_url: "https://downloads.asterisk.org/pub/telephony/asterisk/asterisk-{{ asterisk_version }}-current.tar.gz"

    asterisk_src_dir: "/usr/src/asterisk-{{ asterisk_version_full }}"

    asterisk_archive: "/usr/src/asterisk-{{ asterisk_version }}-current.tar.gz"

- name: Download Asterisk source tarball
  ansible.builtin.get_url:
    url: "{{ asterisk_download_url }}"
    dest: "{{ asterisk_archive }}"
    mode: "0644"
  register: download_result
  until: download_result is succeeded
  retries: 3
  delay: 5

- name: Create Asterisk source directory (using assumed name)
  ansible.builtin.file:
    path: "{{ asterisk_src_dir }}"
    state: directory
    mode: "0755"

- name: Unpack Asterisk source tarball
  ansible.builtin.unarchive:
    src: "{{ asterisk_archive }}"
    dest: /usr/src
    remote_src: yes

    creates: "{{ asterisk_src_dir }}/configure"
  register: unarchive_result

- name: Check if expected source directory exists
  ansible.builtin.stat:
    path: "{{ asterisk_src_dir }}/configure"
  register: src_dir_stat
  when: unarchive_result is changed

- name: Fail if expected source directory not found after extraction
  ansible.builtin.fail:
    msg: "Asterisk source directory '{{ asterisk_src_dir }}' not found after extraction. The actual extracted directory name might differ from the expected '{{ asterisk_version_full }}'. Check /usr/src/asterisk-* manually. Consider adjusting 'asterisk_version_full' or using '-current' download URL with dynamic directory detection."
  when:
    - unarchive_result is changed
    - not src_dir_stat.stat.exists

- name: Run Asterisk configure script
  ansible.builtin.command:
    cmd: ./configure --with-jansson-bundled --with-pjproject-bundled
    chdir: "{{ asterisk_src_dir }}"
    creates: "{{ asterisk_src_dir }}/Makefile"

- name: Run 'make menuselect' options (automated)
  ansible.builtin.command:
    cmd: >
      make menuselect.makeopts &&
      menuselect/menuselect
      --enable CORE-SOUNDS-EN-ULAW
      --enable MOH-OPSOUND-ULAW
      --enable EXTRA-SOUNDS-EN-ULAW
      --enable app_macro
      --enable format_mp3
      --enable res_config_odbc
      --enable res_odbc
      --enable cdr_adaptive_odbc
      --enable cel_odbc
      --enable res_calendar_caldav
      --enable res_calendar_ews
      --enable res_calendar_icalendar
      --enable res_crypto
      --enable res_http_websocket
      --enable res_pjsip_pubsub
      --enable res_pjsip_transport_websocket
      --enable res_srtp
      --enable codec_opus
      --disable BUILD_NATIVE
      --force

    chdir: "{{ asterisk_src_dir }}"
    creates: "{{ asterisk_src_dir }}/menuselect.makeopts"

- name: Compile Asterisk (make)
  ansible.builtin.command:
    cmd: make -j {{ ansible_processor_vcpus | default(2) }}
    chdir: "{{ asterisk_src_dir }}"
    creates: "{{ asterisk_src_dir }}/main/asterisk"

- name: Install Asterisk (make install)
  ansible.builtin.command:
    cmd: make install
    chdir: "{{ asterisk_src_dir }}"
    creates: /usr/sbin/asterisk

- name: Install Asterisk sample configuration files (optional but recommended)
  ansible.builtin.command:
    cmd: make samples
    chdir: "{{ asterisk_src_dir }}"
    creates: /etc/asterisk/asterisk.conf.sample

- name: Install Asterisk init scripts/systemd unit (make config)
  ansible.builtin.command:
    cmd: make config
    chdir: "{{ asterisk_src_dir }}"
    creates: /lib/systemd/system/asterisk.service

- name: Set ownership for Asterisk directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: asterisk
    group: asterisk
    recurse: yes
  with_items:
    - /etc/asterisk
    - /var/lib/asterisk
    - /var/log/asterisk
    - /var/spool/asterisk

- name: Ensure /var/run/asterisk exists
  ansible.builtin.file:
    path: /var/run/asterisk
    state: directory
    owner: asterisk
    group: asterisk
    mode: "0755"

- name: Configure ODBC INI file
  ansible.builtin.template:
    src: odbc.ini.j2
    dest: /etc/odbc.ini
    owner: root
    group: root
    mode: "0644"
  notify: Reload asterisk

- name: Configure ODBCINST INI file
  ansible.builtin.template:
    src: odbcinst.ini.j2
    dest: /etc/odbcinst.ini
    owner: root
    group: root
    mode: "0644"

- name: Enable and start Asterisk service
  ansible.builtin.systemd:
    name: asterisk
    enabled: yes
    state: started
    daemon_reload: yes
